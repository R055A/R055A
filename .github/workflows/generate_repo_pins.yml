name: generate-profile-repo-pins

on:
  schedule:
    - cron: '0 0 * * *'
  push:
    paths:
      - '.github/workflows/generate_repo_pins.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v5

      - name: Checkout repo src
        uses: actions/checkout@v5
        with:
          repository: profile-icons/readme-repo-pins-src
          ref: main
          path: readme-repo-pins-src
          fetch-depth: 1

      - name: Setup
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install
        env:
          PIP_DISABLE_PIP_VERSION_CHECK: '1'
        run: |
          python -m pip install --upgrade pip
          pip install -r readme-repo-pins-src/requirements.txt

      - name: Run
        env:
          GH_API_TOKEN: ${{ secrets.GH_API_TOKEN || secrets.GITHUB_TOKEN }}
          GH_USERNAME: ${{ secrets.GH_USERNAME || github.repository_owner }}
          THEME: ${{ secrets.THEME }}
          BG_IMG: ${{ secrets.BG_IMG }}
          NUM_REPO_PINS: ${{ secrets.NUM_REPO_PINS }}
          REPO_NAMES_EXCLUSIVE: ${{ secrets.REPO_NAMES_EXCLUSIVE }}
          IS_EXCLUDE_REPOS_OWNED: ${{ secrets.IS_EXCLUDE_REPOS_OWNED }}
          IS_EXCLUDE_REPOS_CONTRIBUTED: ${{ secrets.IS_EXCLUDE_REPOS_CONTRIBUTED }}
        run: python readme-repo-pins-src/gh_profile_repo_pins.py

      - name: Commit
        env:
          GH_USERNAME: ${{ secrets.GH_USERNAME || github.repository_owner }}
          GH_USER_ID: ${{ env.GH_USER_ID }}
          GH_USER_NAME: ${{ env.GH_USER_NAME }}
        run: |
          git add $(ls README.md */README.md index.md imgs/*.svg 2>/dev/null | grep -v '^ls:')
          if ! git diff --cached --quiet; then
            git config user.name "${GH_USER_NAME}"
            git config user.email "${GH_USER_ID}+${GH_USERNAME}@users.noreply.github.com"
            git commit -m "Auto-update profile repo pins"

            for attempt in 1 2 3; do
              git pull || true
              if git push; then
                break
              fi
              echo "Push fail #$attempt..."
              sleep $(((RANDOM % 8) + 3))
            done
          fi
