name: generate-profile-repo-pins

on:
  schedule:
    - cron: '0 0 * * *'
  push:
    paths:
      - '.github/workflows/generate_repo_pins.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install
        env:
          PIP_DISABLE_PIP_VERSION_CHECK: '1'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run
        env:
          GH_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_USERNAME: ${{ secrets.GH_USERNAME || github.repository_owner }}
          NUM_REPO_PINS: ${{ secrets.NUM_REPO_PINS }}
          REPO_NAMES_EXCLUSIVE: ${{ secrets.REPO_NAMES_EXCLUSIVE }}
          IS_EXCLUDE_REPOS_OWNED: ${{ secrets.IS_EXCLUDE_REPOS_OWNED }}
          IS_EXCLUDE_REPOS_CONTRIBUTED: ${{ secrets.IS_EXCLUDE_REPOS_CONTRIBUTED }}
        run: python gh_profile_repo_pins.py

      - name: Commit
        env:
          GH_USERNAME: ${{ secrets.GH_USERNAME || github.repository_owner }}
          GH_USER_ID: ${{ env.GH_USER_ID }}
          GH_USER_NAME: ${{ env.GH_USER_NAME }}
        run: |
          git add README.md index.md files/*.svg || true
          if ! git diff --cached --quiet; then
            git config user.name "${GH_USER_NAME}"
            git config user.email "${GH_USER_ID}+${GH_USERNAME}@users.noreply.github.com"
            git commit -m "Auto-update profile repo pins" README.md index.md files/*.svg

            for attempt in 1 2 3; do
              git pull || true
              if git push; then
                break
              fi
              echo "Push fail #$attempt..."
              sleep $(((RANDOM % 8) + 3))
            done
          fi
